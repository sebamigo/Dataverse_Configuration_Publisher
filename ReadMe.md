# Microsoft Dynamics 365 CRM Configuration Publisher

This repository demonstrates how to automate deploying Dynamics 365 CRM configurations (e.g., Business Units, Teams, and security role assignments) across multiple environments.

### Why Configuration Publisher for Microsoft Dynamics 365?

- **Consistent configurations across environments:**  
    Automated deployment ensures that settings are identical in multiple environments.

- **Version control with Git:**   
    Every change is documented and easy to review.

- **Automation and repeatability:**  
    Configurations can be deployed reliably and automatically at any time, minimizing manual errors.

- **Fast rollbacks and easy migration:**  
    Quickly revert to previous versions or migrate configurations between environments if needed.

- **Improved collaboration:**  
    Teams can work on configurations in parallel and leverage pull requests for review.


### Advantages of YAML/PowerShell over XML/CMT
- **Readability**: YAML is often easier for humans to read and edit than the data.xml file generated by the Configuration Migration Tool (CMT).

- **Flexibility**: With a custom script, you have full control over the import logic. You can build in complex dependencies or data transformations that would be difficult to achieve with the standard CMT.

- **Diff-Friendliness**: Changes in YAML files are often clearer and more understandable in Git diffs compared to large, nested XML structures.

- **Environment-Agnostic Configuration**: The approach allows for referencing records by name (e.g., looking up a security role by its name within a specific business unit), decoupling the configuration from environment-specific GUIDs and making it more portable.

- **Support for File Uploads**: the approach can managed the deployment of records that include file attachments, such as Notes, which is often a complex or manual process with standard tooling.

**Important!**
The Microsoft Dyanmics data types still need to be aligned in the code. 

Configurations are stored as yaml files, processed by the script, and applied to a Microsoft Dynamics 365 (Dataverse) environment.

**At a glance**
- Purpose: Automatically create/update records and create relationships (associations) in Microsoft Dynamics 365 based on yaml configurations.
- Input: yaml configuration files in [data/configurations](data/configurations) / [tests/TestConfigurations](tests/TestConfigurations).
- Core scripts:
  - Deployment entry point: [DeployConfiguration](scripts/DeployConfiguration.ps1)
  - Publisher logic: [Publish-Configuration](scripts/ConfigPublisher.psm1)
  - Helper functions: [CommonTools](lib/CommonTools.psm1) (`Write-Log`, `Out-Banner`) and [DynamicsTypes](lib/DynamicsTypes.psm1) (utilities for Microsoft Dynamics 365 CRM)

Key functions/modules
- [`Publish-Configuration`](scripts/ConfigPublisher.psm1) — processes yaml files, creates/updates records via `Set-CrmRecord`, and manages relationships (Associate/Disassociate).
- [`FlatFieldsDatatypes`](scripts/ConfigPublisher.psm1) — converts extended data types found in yaml fields (e.g., `$refByField`, `$refBySecRole`, `$file`).

## Dependencies
Install the following tools/modules:

- **Pester (for tests)**  
  Install the Pester PowerShell module:  
  ```powershell
  Install-Module -Name Pester
  ```

- **YAML Support**  
  Install the yaml PowerShell module:  
  ```powershell
  Install-Module -Name powershell-yaml
  ```

- **Microsoft.Xrm.Tooling.CrmConnector.PowerShell**  
  PowerShell module for connecting to Microsoft Dynamics CRM.
  ```powershell
  Install-Module -Name Microsoft.Xrm.Tooling.CrmConnector.PowerShell
  ```

- **Microsoft.Xrm.Data.PowerShell**  
  PowerShell module for working with Microsoft Dynamics CRM data.
  ```powershell
  Install-Module -Name Microsoft.Xrm.Data.PowerShell
  ```
Make sure all modules above are installed to run the project scripts.

## How to deploy (locally)
1. Ensure the required PowerShell modules are installed (see above).
2. Configure the yaml files under [data/configurations](data/configurations).
3. Run the deploy script (interactive CRM connection):
   ```powershell
   .\scripts\DeployConfiguration.ps1 -ConfigPath ".\data\configurations"
   ```
4. Sign in to Microsoft Dynamics 365.
5. The script applies the configurations to Dataverse.

It's best to thoroughly test your configurations first! :)

**How to run tests**
- In VS Code: Use the "Run Pester tests" task (see [.vscode/tasks.json](.vscode/tasks.json)).
- Manually:
  ```powershell
  Import-Module Pester;
  Invoke-Pester;
  ```
- **Important!** The tests use an in-memory mock repository ([tests/CrmMock/CrmConnector.Mock.psm1](tests/CrmMock/CrmConnector.Mock.psm1)), allowing you to validate the publisher logic without a live Dynamics instance. This helps verify that the yaml configurations are set up correctly.

## More
**Extended data types in yaml**

- Some yaml fields support extended types that the publisher resolves on load and converts into appropriate CRM/PowerShell objects. These extended types let you describe complex references, files, or special data types cleanly in the yaml configurations. Resolution is implemented in [`DynamicsTypes`](lib/DynamicsTypes.psm1).


See [data/configurations](data/configurations) for examples of the expected yaml structure.